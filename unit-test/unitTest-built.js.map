{"version":3,"file":"unitTest-built.js","sources":["../src/mvvm/handlers.js","../src/mvvm/observer.js","unitTest.js"],"sourcesContent":["/**\n * Depend 处理 Handler 的添加、删除\n */\nexport default class Handlers {\n  constructor() {\n    this._cache = []\n  }\n  /**\n   * addHandler 添加一个回调函数\n   * @param {Function} handler 回调函数\n   * @returns {undefined}\n   */\n  addHandler(handler) {\n    this._cache.push(handler)\n  }\n\n\n  notify(prop) {\n    this._cache.forEach((x) => x(prop))\n  }\n\n  destroy() {\n    this._cache = []\n  }\n}\n","import Handlers from './handlers'\n\n/** 用于存放数据 */\nconst PRIVATE_DATA_KEY = '__observe__'\n/** 用于在代理对象中存放 handlers */\nconst HANDLERS_KEY = `${PRIVATE_DATA_KEY}.__handlers__`\n/** 用于在代理对象中存放 property */\nconst PROP_KEY = `${PRIVATE_DATA_KEY}.__property__`\n\n/** array 代理操作 */\nconst ARRAY_ORP = ['push', 'pop', 'shift', 'unshift', 'splice', 'sort', 'reverse']\n\n/**\n * Observer 实现了对象代理\n */\nexport default class Observer {\n  constructor(data) {\n    this._data = data\n    Observer._observeObj(this._data)\n  }\n  static _observeObj(data) {\n    if (typeof data !== 'object') {\n      throw new TypeError('argument data must be object')\n    }\n    Object.keys(data).forEach((prop) => {\n      defineProperty(data, prop, data[prop])\n      if (typeof data[prop] === 'object' && !Array.isArray(data[prop])) {\n        Observer._observeObj(data[prop])\n        // 嵌套的子对象的属性在发生变化时会通知父亲对象\n        data[prop][HANDLERS_KEY].addHandler(() => data[HANDLERS_KEY].notify(prop))\n      }\n      // array 操作也会通知\n      if (Array.isArray(data[prop])) {\n        ARRAY_ORP.forEach((opt) => {\n          const arrayTarget = data[PROP_KEY][prop]\n          arrayTarget[opt] = function () {\n            Array.prototype[opt].apply(arrayTarget, arguments)\n            data[HANDLERS_KEY].notify(prop)\n          }\n        })\n      }\n    })\n  }\n  /**\n   * 外部观察接口\n   * @param {Function} callback 回调函数\n   * @returns {undefined}\n   */\n  onChange(callback) {\n    this._data[HANDLERS_KEY].addHandler(callback)\n  }\n  data() {\n    return this._data\n  }\n}\n\n/**\n * @param {Object} obj 观察者对象\n * @param {string} prop 需要观察的属性\n * @param {any} val 需要观察属性的初始化值\n * @returns {undefined}\n */\nexport function defineProperty(obj, prop, val) {\n  if (prop === PRIVATE_DATA_KEY) {\n    throw new Error('cannot define private property')\n  }\n  if (typeof val === 'undefined') {\n    val = obj[prop]\n  }\n  if (typeof obj[HANDLERS_KEY] === 'undefined') {\n    obj[HANDLERS_KEY] = new Handlers()\n  }\n  if (typeof obj[PROP_KEY] === 'undefined') {\n    obj[PROP_KEY] = {}\n  }\n  const handlers = obj[HANDLERS_KEY]\n  obj[PROP_KEY][prop] = val\n  Object.defineProperty(obj, prop, {\n    get() {\n      return obj[PROP_KEY][prop]\n    },\n    set(newVal) {\n      if (newVal !== obj[PROP_KEY][prop]) {\n        obj[PROP_KEY][prop] = newVal\n        handlers.notify(prop)\n      }\n    }\n  })\n}\n","import Observer from '../src/mvvm/observer'\r\n\r\ndescribe('observer', function(){\r\n    it('set prop properly', function () {\r\n        let o = new Observer({\r\n            users: [0, 1, 2, 3],\r\n            key: 'val'\r\n        })\r\n        let data = o.data()\r\n        expect(data.key).toBe('val')\r\n    })\r\n    it('primitive prop change', function(){\r\n        let changed = false\r\n        let o = new Observer({\r\n            users: [0, 1, 2, 3],\r\n            key: 'val'\r\n        })\r\n        let data = o.data()\r\n        o.onChange(function(prop){\r\n            if(prop === 'key'){\r\n                changed = true\r\n            }\r\n        })\r\n        data.key = 'val.'\r\n        expect(changed).toBe(true)\r\n    })\r\n    it('primitive prop not change', function () {\r\n        let changed = false\r\n        let o = new Observer({\r\n            users: [0, 1, 2, 3],\r\n            key: 'val'\r\n        })\r\n        let data = o.data()\r\n        o.onChange(function (prop) {\r\n            if (prop === 'key') {\r\n                changed = true\r\n            }\r\n        })\r\n        data.key = 'val'\r\n        expect(changed).toBe(false)\r\n    })\r\n    it('object prop change', function () {\r\n        let changed = false\r\n        let o = new Observer({\r\n            users: [0, 1, 2, 3],\r\n            key: 'val',\r\n            o: {\r\n                key: 'val'\r\n            }\r\n        })\r\n        let data = o.data()\r\n        o.onChange(function (prop) {\r\n            if (prop === 'o') {\r\n                changed = true\r\n            }\r\n        })\r\n        data.o.key = 'val.'\r\n        expect(changed).toBe(true)\r\n    })       \r\n    it('observe array prop change', function () {\r\n        let changed = false\r\n        let o = new Observer({\r\n            users: [0, 1, 2, 3],\r\n            key: 'val'\r\n        })\r\n        let data = o.data()\r\n        o.onChange(function (prop) {\r\n            if (prop === 'users') {\r\n                changed = true\r\n            }\r\n        })\r\n        data.users.push('val.')\r\n        expect(data.users.push === Array.prototype.push).toBe(false)\r\n        expect(changed).toBe(true)\r\n    })\r\n})\r\n\r\n\r\n\r\n"],"names":["Handlers","_cache","handler","push","prop","forEach","x","PRIVATE_DATA_KEY","HANDLERS_KEY","PROP_KEY","ARRAY_ORP","Observer","data","_data","_observeObj","TypeError","keys","Array","isArray","addHandler","notify","opt","arrayTarget","prototype","apply","arguments","callback","defineProperty","obj","val","Error","handlers","newVal","describe","o","key","toBe","changed","onChange","users"],"mappings":"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"}